import json
import urllib.parse
import boto3
import datetime
import subprocess

s3 = boto3.client('s3')

print('Loading function')

s3 = boto3.client('s3')
now = datetime.datetime.now()
tagValue = now.date()

def lambda_handler(event, context):
    print("Recevied event: " + json.dumps(event, indent=2))

    #Get the object from the event
    bucket = event['Records'][0]['s3']['bucket']['name']
    key = urllib.parse.unquote_plus(event['Records'][0]['s3']['object']['key'], encoding='utf-8')
    response = s3.get_object(Bucket=bucket, Key=key)

    file_download_path = f'/tmp/{key.split("/")[-1]}'
    with open(file_download_path,'wb+') as file:
        file.write(response['Body'].read())   

    try:
        file_count_KB = subprocess.check_output(
            'stat -c %s ' + file_download_path,
            shell=True,
            stderr=subprocess.STDOUT 
        ).decode().strip()
    except Exception as e:
        print(e)

    try:
        response = s3.put_object_tagging(
            Bucket = bucket,
            Key = key,
            Tagging={
                'TagSet': [
                    {
                        'Key' : 'FileSize', 
                        'Value' : file_count_KB
                    }
                ]
            }
        )
    except Exception as e:
        print(e)